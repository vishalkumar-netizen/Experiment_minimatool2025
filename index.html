<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviation Minimums Calculator</title>
    <style>
        /* Base Styling */
        body { font-family: 'Inter', Arial, sans-serif; background: #eef2f6; padding: 20px; line-height: 1.5; }
        .container { max-width: 1300px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1e3a8a; margin-bottom: 25px; font-weight: 700; }
        
        /* Top Input Fields & Controls */
        .top-inputs { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 20px; 
            align-items: flex-end; /* Align inputs nicely */
            flex-wrap: wrap; 
            padding-bottom: 15px; 
            border-bottom: 1px solid #e0e7ff; 
        }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-weight: 600; color: #4b5563; font-size: 0.9rem; }
        .input-group input, .input-group select { 
            padding: 10px; 
            border: 2px solid #d1d5db; 
            border-radius: 6px; 
            width: 120px; 
            transition: border-color 0.3s;
        }
        .input-group input:focus, .input-group select:focus { border-color: #3b82f6; outline: none; }

        /* Conversion Toggle */
        .toggle-wrapper { border: 1px solid #d1d5db; padding: 8px 12px; border-radius: 6px; background: #f9fafb; display: flex; flex-direction: column; justify-content: center; }
        .toggle-label { font-size: 0.85rem; color: #4b5563; margin-bottom: 4px; font-weight: 600; }
        .toggle-control { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9rem; }

        /* Procedure Selection */
        .procedure-group { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 10px 0;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 10px;
            margin-top: 5px;
        }
        .proc-checkbox-group { margin: 16px 0 10px 0; display: flex; flex-wrap: wrap; gap: 18px; border-bottom: 1px solid #e5e7eb; padding-bottom: 15px; padding-top: 10px; }
        
        /* Calculator Grid */
        .calculators { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); 
            gap: 25px; 
            margin-top: 30px; 
        }
        .calculator { 
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            padding: 20px; 
            background: #ffffff; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .calculator h3 { 
            text-align: center; 
            margin-bottom: 20px; 
            color: #1f2937; 
            background: #f3f4f6; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 1.15rem;
        }
        .cat-row { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 12px; 
            padding: 8px; 
            border-radius: 4px; 
            background: #fafafa;
        }
        .cat-label { font-weight: 700; width: 60px; color: #4b5563; font-size: 0.95rem; }
        .cat-row input { width: 65px; padding: 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9rem; }
        .result { margin-left: auto; font-weight: 700; color: #10b981; font-size: 0.95em; white-space: nowrap; }
        .result-noncdfa { color: #ef4444 !important; font-size: 0.85em; margin-top: 2px; }

        /* Buttons */
        .button-container { text-align: center; margin-top: 30px; }
        .calculate-btn { 
            background: #3b82f6; 
            color: white; 
            padding: 12px 30px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600;
            margin: 0 10px; 
            transition: background 0.3s, transform 0.1s;
        }
        .calculate-btn:hover { background: #2563eb; transform: translateY(-1px); }
        .calculate-btn:nth-child(2) { background: #6b7280; }
        .calculate-btn:nth-child(2):hover { background: #4b5563; }

        /* Summary */
        #summaryResults { border-top: 2px solid #d1d5db; padding-top: 20px; margin-top: 30px; }
        #summaryResults h2 { text-align: center; color: #1e3a8a; margin-bottom: 15px; font-size: 1.5rem; }
        #summaryResults h3 { margin-top: 15px; margin-bottom: 5px; color: #4b5563; border-left: 4px solid #3b82f6; padding-left: 8px; }

        /* Responsive adjustments */
        @media (max-width: 768px) {
          .top-inputs { flex-direction: column; align-items: stretch; }
          .input-group input, .input-group select { width: 100%; }
          .procedure-group { flex-direction: column; align-items: flex-start; gap: 8px; }
          .noncdfa-sub-group { margin-left: 0; }
          .calculate-btn { display: block; width: 100%; margin: 10px 0; }
          .calculators { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Aviation Minimums Calculator</h1>
        
        <div class="top-inputs">
            <div class="input-group">
                <label for="adElev">AD Elev (ft)</label>
                <input type="number" id="adElev" placeholder="0" value="0">
            </div>
            <div class="input-group">
                <label for="thrElev">THR Elev (ft)</label>
                <input type="number" id="thrElev" placeholder="0" value="0">
            </div>
            
            <div class="toggle-wrapper">
                <span class="toggle-label">DH/MDH Input Unit</span>
                <label class="toggle-control">
                    <input type="checkbox" id="meterToFeetToggle">
                    <span>Input in Meters</span>
                </label>
            </div>

            <div class="input-group">
                <label for="lightType">Approach Light System (ALS)</label>
                <select id="lightType">
                    <option value="FALS">FALS</option>
                    <option value="IALS">IALS</option>
                    <option value="BALS">BALS</option>
                    <option value="NALS">NALS</option>
                </select>
            </div>
            
            <div class="procedure-group">
                <label style="font-weight: 700;">Calculation Mode:</label>
                <div style="display:flex; gap: 10px;">
                    <input type="radio" name="procedure" value="CDFA" id="cdfa" checked>
                    <label for="cdfa">CDFA (Default)</label>
                </div>
                <div style="display:flex; gap: 10px;">
                    <input type="radio" name="procedure" value="Non-CDFA" id="noncdfa">
                    <label for="noncdfa">Non CDFA</label>
                </div>
                <!-- Non-CDFA Sub-selection (Hidden by default) -->
                <div id="noncdfaSubGroup" style="display:none; margin-top: 8px; border-left: 2px solid #f97316; padding-left: 10px;">
                    <label><input type="checkbox" id="noncdfa_ab"> CAT A/B only</label>
                    <label><input type="checkbox" id="noncdfa_cd"> CAT C/D only</label>
                </div>
            </div>
        </div>

        <div class="proc-checkbox-group" id="procedureCheckboxes">
            <h2 style="font-size: 1.2rem; color: #4b5563;">Select Approaches to Display:</h2>
        </div>

        <div class="calculators" id="calculatorsArea">
            <!-- Calculators will be dynamically generated here -->
        </div>

        <div class="button-container">
            <button class="calculate-btn" onclick="calculate()">Calculate Minimums</button>
            <button class="calculate-btn" type="button" onclick="clearAllInputs()">Clear All</button>
        </div>

        <div id="summaryResults">
            <!-- Results will be displayed here -->
        </div>

        <div style="text-align: center; margin-top: 40px; color: #9ca3af; font-size: 0.8rem;">
            Experiment Tool (For demonstration purposes only).
        </div>
    </div>
    
    <script>
        // === DATA TABLES & CONSTANTS ===
        const PRECISION_PROC = [
            { code: 'cat1', name: 'CAT 1' }, { code: 'rnp', name: 'RNP' }, { code: 'gls', name: 'GLS' },
            { code: 'par', name: 'PAR' }, { code: 'lpv', name: 'LPV' }, { code: 'lnavvnav', name: 'LNAV/VNAV' }
        ];
        const NONPRECISION_PROC_250 = [
            { code: 'loc', name: 'LOC' }, { code: 'locdme', name: 'LOC+DME' }, { code: 'vordme', name: 'VOR+DME' },
            { code: 'lnav', name: 'LNAV' }, { code: 'sra', name: 'SRA' }, { code: 'lda', name: 'LDA' }
        ];
        const NONPRECISION_PROC_300 = [
            { code: 'vor', name: 'VOR' }, { code: 'ndbdme', name: 'NDB+DME' }
        ];
        const NONPRECISION_PROC_350 = [{ code: 'ndb', name: 'NDB' }];
        const CIRCLING_PROC = [{ code: 'circling', name: 'Circling' }];
        const CATS = ['A','B','C','D'];
        const FT_PER_M = 3.28084;

        // RVR Minima Table (Partial/Example Data based on previous response)
        const RVR_TABLE_RANGES = [
            {low: 200, high: 210, FALS: 550, IALS: 750, BALS: 1000, NALS: 1200},
            {low: 241, high: 250, FALS: 550, IALS: 800, BALS: 1000, NALS: 1300},
            {low: 251, high: 260, FALS: 600, IALS: 800, BALS: 1100, NALS: 1300},
            {low: 301, high: 320, FALS: 700, IALS: 1000, BALS: 1200, NALS: 1400},
            {low: 361, high: 380, FALS: 1000, IALS: 1300, BALS: 1500, NALS: 1700},
            {low: 481, high: 500, FALS: 1500, IALS: 1800, BALS: 2100, NALS: 2300},
            {low: 601, high: 620, FALS: 2100, IALS: 2400, BALS: 2600, NALS: 2800},
            {low: 761, high: 800, FALS: 2900, IALS: 3200, BALS: 3400, NALS: 3600},
            {low: 1201, high: 9999, FALS: 5000, IALS: 5000, BALS: 5000, NALS: 5000} // High end limit
        ];
        
        // === UTILITY FUNCTIONS ===
        function getRVRFromTable(dh, lightType) {
            if (dh <= 0) return 9999;
            for (let row of RVR_TABLE_RANGES) {
                if (dh >= row.low && dh <= row.high) return row[lightType] || 5000;
            }
            return RVR_TABLE_RANGES[RVR_TABLE_RANGES.length-1][lightType] || 5000;
        }
        
        function roundUpTo10(x) { return Math.ceil(x/10)*10; }

        // === UI GENERATION ===
        function renderProcedureCheckboxes() {
            let html = `<h2>Select Approaches to Display:</h2>`;
            const allProcedures = [...PRECISION_PROC, ...NONPRECISION_PROC_250, ...NONPRECISION_PROC_300, ...NONPRECISION_PROC_350, ...CIRCLING_PROC];
            
            allProcedures.forEach(p => { 
                html += `<label style="display:inline-flex; align-items:center; gap:5px;"><input type="checkbox" id="show_${p.code}" checked> ${p.name}</label>`; 
            });
            
            document.getElementById('procedureCheckboxes').innerHTML = html;
        }

        function renderCalculators() {
            let html = "";
            const catRows = (proc, inputTypes) => CATS.map(cat=>{
                // DA/MDA and DH/MDH inputs are mutually exclusive per type
                const hasMDA = inputTypes.includes('MDA');
                const hasDH = inputTypes.includes('DH');
                
                let fields = '';
                if(hasDH) fields += `<input type="number" placeholder="DH" id="${proc}_${cat}_dh">`;
                if(hasMDA) fields += `<input type="number" placeholder="MDA" id="${proc}_${cat}_mda">`;
                
                if(hasDH) fields += `<input type="number" placeholder="DA" id="${proc}_${cat}_da">`;
                if(hasMDA) fields += `<input type="number" placeholder="MDH" id="${proc}_${cat}_mdh">`;
                
                if(inputTypes.includes('RVR'))  fields += `<input type="number" placeholder="RVR (m)" id="${proc}_${cat}_rvr">`;
                if(inputTypes.includes('VIS'))  fields += `<input type="number" placeholder="VIS (km)" id="${proc}_${cat}_vis" step="0.1">`;
                
                return `<div class="cat-row">
                            <div class="cat-label">CAT ${cat}</div>
                            ${fields}
                            <div>
                                <div class="result" id="${proc}_${cat}_result"></div>
                                <!-- Placeholder for custom Non-CDFA result if applicable -->
                            </div>
                        </div>`;
            }).join('');

            // Precision approaches (DA/DH, RVR)
            PRECISION_PROC.forEach(proc=>{
                html += `<div class="calculator" id="${proc.code}Calculator">
                    <h3>${proc.name}</h3>
                    ${catRows(proc.code, ['DA','DH','RVR'])}
                </div>`;
            });
            
            // Non-precision approaches (MDA/MDH, RVR)
            [...NONPRECISION_PROC_250, ...NONPRECISION_PROC_300, ...NONPRECISION_PROC_350].forEach(proc=>{
                html += `<div class="calculator" id="${proc.code}Calculator">
                    <h3>${proc.name}</h3>
                    ${catRows(proc.code, ['MDA','MDH','RVR'])}
                </div>`;
            });
            
            // Circling (MDA/MDH, VIS)
            html += `<div class="calculator" id="circlingCalculator">
                <h3>Circling</h3>
                ${catRows('circling', ['MDA','MDH','VIS'])}
            </div>`;
            
            document.getElementById('calculatorsArea').innerHTML = html;
        }

        function updateCalculatorVisibility() {
            const allProcedures = [...PRECISION_PROC, ...NONPRECISION_PROC_250, ...NONPRECISION_PROC_300, ...NONPRECISION_PROC_350, ...CIRCLING_PROC];
            allProcedures.forEach(proc=>{
                const show = document.getElementById('show_'+proc.code)?.checked;
                const calculatorElement = document.getElementById(proc.code+'Calculator');
                if (calculatorElement) {
                    calculatorElement.style.display = show ? 'block':'none';
                }
            });
        }
        
        // === CORE CALCULATION LOGIC ===
        function calculate() {
            const adElev = parseFloat(document.getElementById('adElev').value)||0;
            const thrElev = parseFloat(document.getElementById('thrElev').value)||0;
            const lightType = document.getElementById('lightType').value;
            const useMeters = document.getElementById('meterToFeetToggle').checked;
            
            // Helper: Converts input value from M to FT if toggle is ON, otherwise returns FT value.
            const getVal = (id) => {
                const val = parseFloat(document.getElementById(id).value)||0;
                if (!val) return 0;
                // Note: RVR is always taken as meters, so no conversion for RVR inputs here.
                return useMeters ? Math.round(val * FT_PER_M) : val;
            };

            // Non-CDFA filtering logic
            const isNonCDFA = document.getElementById('noncdfa').checked;
            const isNonCDFA_AB = document.getElementById('noncdfa_ab').checked;
            const isNonCDFA_CD = document.getElementById('noncdfa_cd').checked;

            function isNonCDFAForCat(cat){
                if(!isNonCDFA) return false;
                if(!isNonCDFA_AB && !isNonCDFA_CD) return true;
                if(isNonCDFA_AB && isNonCDFA_CD) return true;
                if(isNonCDFA_AB && ['A','B'].includes(cat)) return true;
                if(isNonCDFA_CD && ['C','D'].includes(cat)) return true;
                return false;
            }

            let summary = {};

            // 1. PRECISION Approaches (DH/DA)
            PRECISION_PROC.forEach(proc=>{
                if(!document.getElementById('show_'+proc.code)?.checked) return;
                summary[proc.code] = {};
                
                CATS.forEach(cat=>{
                    const dh = getVal(`${proc.code}_${cat}_dh`);
                    const da = getVal(`${proc.code}_${cat}_da`);
                    const rvr = parseFloat(document.getElementById(`${proc.code}_${cat}_rvr`)?.value)||0; 
                    
                    if (dh === 0 && da === 0 && rvr === 0) {
                        document.getElementById(`${proc.code}_${cat}_result`).innerText = '';
                        return;
                    }
                    
                    // DH floor: 250 for LNAV/VNAV, 200 for others
                    const dhFloor = (proc.code === "lnavvnav") ? 250 : 200;
                    const dhRaised = Math.max(dh, dhFloor);
                    const daCalc = roundUpTo10(thrElev + dhRaised);
                    const daFinal = Math.max(da, daCalc);
                    
                    // RVR Calculation
                    const rvrTable = getRVRFromTable(dhRaised, lightType);
                    let rvrFinal = Math.max(rvrTable, rvr); 
                    
                    // Apply Non-CDFA RVR cap exception
                    if(!isNonCDFAForCat(cat)) {
                        const maxRVR = ['A','B'].includes(cat)?1500:2400;
                        if(rvrFinal>maxRVR && (!rvr || rvr<=maxRVR)) rvrFinal=maxRVR;
                    }
                    
                    const res = `DA: ${daFinal} ft (DH: ${dhRaised} ft), RVR: ${rvrFinal} m`;
                    document.getElementById(`${proc.code}_${cat}_result`).innerText = res;
                    summary[proc.code][cat] = res;
                });
            });

            // 2. NON-PRECISION Approaches (MDH/MDA)
            [...NONPRECISION_PROC_250, ...NONPRECISION_PROC_300, ...NONPRECISION_PROC_350].forEach(proc=>{
                if(!document.getElementById('show_'+proc.code)?.checked) return;
                summary[proc.code] = {};
                
                let minMDH = 250;
                if(NONPRECISION_PROC_300.some(p=>p.code===proc.code)) minMDH=300;
                if(NONPRECISION_PROC_350.some(p=>p.code===proc.code)) minMDH=350;
                
                CATS.forEach(cat=>{
                    const mdh = getVal(`${proc.code}_${cat}_mdh`);
                    const mda = getVal(`${proc.code}_${cat}_mda`);
                    const rvr = parseFloat(document.getElementById(`${proc.code}_${cat}_rvr`)?.value)||0;

                    if (mdh === 0 && mda === 0 && rvr === 0) {
                        document.getElementById(`${proc.code}_${cat}_result`).innerText = '';
                        return;
                    }

                    // 1. MDH Floor Application
                    let mdhUsed = Math.max(mdh, minMDH);
                    
                    // 2. MDA Calculation (from MDH and THR Elev)
                    let mdaCalc = roundUpTo10(thrElev + mdhUsed);
                    let mdaFinal = Math.max(mda, mdaCalc);
                    
                    const resultEl = document.getElementById(`${proc.code}_${cat}_result`);
                    
                    // Rule Exception: MDH > 1200 ft
                    if(mdhUsed > 1200) {
                        const msg = `MDA: ${mdaFinal} ft (MDH: ${mdhUsed} ft), RVR: 5000 m (MDH > 1200 ft)`;
                        resultEl.innerText = msg;
                        summary[proc.code][cat] = msg;
                        return; 
                    }

                    // 3. RVR Calculation
                    const rvrTable = getRVRFromTable(mdhUsed, lightType);
                    let rvrFinal;

                    if(!isNonCDFAForCat(cat)) { 
                        // CDFA Mode / Standard Rules
                        rvrFinal = Math.max(750, rvrTable, rvr);
                        const maxRVR = ['A','B'].includes(cat)?1500:2400;
                        if(rvrFinal>maxRVR && (!rvr || rvr<=maxRVR)) rvrFinal=maxRVR;
                    } else { 
                        // Non-CDFA Mode
                        let minRVR = ['A','B'].includes(cat)?1000:1200;
                        rvrFinal = Math.max(minRVR, rvrTable, rvr);
                    }
                    
                    const res = `MDA: ${mdaFinal} ft (MDH: ${mdhUsed} ft), RVR: ${rvrFinal} m`;
                    resultEl.innerText = res;
                    summary[proc.code][cat] = res;
                });
            });

            // 3. CIRCLING Approaches
            if(document.getElementById('show_circling')?.checked) {
                summary.circling = {};
                const catMins = {A:400,B:500,C:600,D:700};
                const visDefaults = {A:1.5,B:1.6,C:2.4,D:3.6};
                
                CATS.forEach(cat=>{
                    const mda = getVal(`circling_${cat}_mda`);
                    const mdh = getVal(`circling_${cat}_mdh`);
                    const vis = parseFloat(document.getElementById(`circling_${cat}_vis`)?.value)||0;
                    
                    if (mdh === 0 && mda === 0 && vis === 0) {
                        document.getElementById(`circling_${cat}_result`).innerText = '';
                        return;
                    }

                    const mdhUsed = Math.max(mdh, catMins[cat]);
                    const mdaCalc = roundUpTo10(adElev+mdhUsed); // Use AD Elev for circling MDA
                    const mdaFinal = Math.max(mda, mdaCalc);
                    const visFinal = Math.max(vis||0, visDefaults[cat]);
                    
                    const res = `MDA: ${mdaFinal} ft (MDH: ${mdhUsed} ft), VIS: ${visFinal} km`;
                    document.getElementById(`circling_${cat}_result`).innerText = res;
                    summary.circling[cat] = res;
                });
            }
            updateSummaryResults(summary);
        }

        // === POST-CALCULATION UI ===
        function updateSummaryResults(results) {
            const blocks = [
                ...PRECISION_PROC, ...NONPRECISION_PROC_250, ...NONPRECISION_PROC_300, ...NONPRECISION_PROC_350, ...CIRCLING_PROC
            ].filter(proc => document.getElementById('show_'+proc.code)?.checked);
            
            let html = `<h2>Summary of Results</h2>`;
            blocks.forEach(proc=>{
                if(!results[proc.code] || Object.values(results[proc.code]).every(res => res === '')) return; // Skip if no results
                html += `<div style="margin-bottom:14px;"><h3>${proc.name}</h3>`;
                CATS.forEach(cat=>{
                    if(results[proc.code][cat]) html += `<div>CAT ${cat}: ${results[proc.code][cat]}</div>`;
                });
                html += `</div>`;
            });
            document.getElementById('summaryResults').innerHTML = html || '<div style="text-align:center; color:#6b7280;">Enter values and calculate to see the summary.</div>';
        }

        function clearAllInputs() {
            document.querySelectorAll('input[type="number"]').forEach(el => el.value = '0');
            document.querySelectorAll('input[type="text"]').forEach(el => el.value = ''); // Just in case
            document.querySelectorAll('.result').forEach(el => el.innerText = '');
            document.getElementById('summaryResults').innerHTML = '';
            
            // Reset controls
            document.getElementById('cdfa').checked = true;
            document.getElementById('noncdfaSubGroup').style.display = 'none';
            document.getElementById('noncdfa_ab').checked = false;
            document.getElementById('noncdfa_cd').checked = false;
            document.getElementById('meterToFeetToggle').checked = false;
            
            // Default check ALL procedures
            const allProcedures = [...PRECISION_PROC, ...NONPRECISION_PROC_250, ...NONPRECISION_PROC_300, ...NONPRECISION_PROC_350, ...CIRCLING_PROC];
            allProcedures.forEach(proc => {
                let el = document.getElementById('show_'+proc.code);
                if(el) el.checked = true;
            });

            updateCalculatorVisibility();
            calculate(); // Re-run to update summary with empty data
        }

        // === INITIALIZATION & EVENT LISTENERS ===
        window.onload = function() {
            renderProcedureCheckboxes();
            renderCalculators();
            updateCalculatorVisibility();
            
            // Event delegation for input and changes
            document.addEventListener('input',function(e){ 
                if(['number','checkbox','select-one'].includes(e.target.type) || ['adElev','thrElev','lightType'].includes(e.target.id)) {
                    calculate(); 
                }
            });
            document.addEventListener('change',function(e){
                if(['radio','checkbox','select-one'].includes(e.target.type)) {
                    updateCalculatorVisibility();
                    calculate();
                }
            });

            // Non-CDFA Radio button toggle for sub-options
            document.getElementById('noncdfa').addEventListener('change',function(){
                document.getElementById('noncdfaSubGroup').style.display = this.checked ? 'flex':'none';
            });
            document.getElementById('cdfa').addEventListener('change',function(){
                document.getElementById('noncdfaSubGroup').style.display = 'none';
                document.getElementById('noncdfa_ab').checked = false;
                document.getElementById('noncdfa_cd').checked = false;
            });
            
            // Checkbox change listener for visibility
            document.getElementById('procedureCheckboxes').addEventListener('change', updateCalculatorVisibility);

            // Initial calculation (to set up empty state)
            calculate();
        };
    </script>
</body>
</html>
